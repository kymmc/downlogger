pipeline {
    agent none
    options {
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '12'))
        timeout(time: 30, unit: 'MINUTES')
    }
    environment {
        DOCKER_REGISTRY = 'docker-scicomp.artifactory.ihme.washington.edu'
        DOCKER_REGISTRY_CREDENTIALS = 'artifactory-docker-scicomp'
        KUBECONFIG_SECRET_NAME = 'k8s-scicomp-cluster-kubeconf-aks'
        K8S_NAMESPACE = 'downlogger-prod'
        IMAGE_NAME = 'downlogger'
        DEPLOY_VERSION = "${env.BUILD_NUMBER}"
    }
    stages {
        stage('Checkout') {
            steps {
                node('docker') {
                    checkout scm
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                node('docker') {
                    script {
                        // Build Docker image on Jenkins agent (has Docker)
                        sh '''
                            chmod +x build-and-deploy.sh
                            ./build-and-deploy.sh ${DEPLOY_VERSION} --build-only
                        '''
                    }
                }
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                node('docker') {
                    script {
                        // Install kubectl and deploy
                        sh '''
                            # Install kubectl
                            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                            chmod +x kubectl
                            sudo mv kubectl /usr/local/bin/
                            
                            # Set up kubeconfig
                            echo "${KUBECONFIG}" > /tmp/kubeconfig
                            export KUBECONFIG=/tmp/kubeconfig
                            
                            # Deploy to Kubernetes
                            kubectl apply -f k8s/
                            kubectl rollout status deployment/downlogger -n ${K8S_NAMESPACE} --timeout=300s
                        '''
                    }
                }
            }
        }
        stage('Verify Deployment') {
            steps {
                node('docker') {
                    script {
                        sh '''
                            # Set up kubeconfig
                            echo "${KUBECONFIG}" > /tmp/kubeconfig
                            export KUBECONFIG=/tmp/kubeconfig
                            
                            echo "Waiting for deployment to be ready..."
                            kubectl wait --for=condition=available --timeout=300s deployment/downlogger -n ${K8S_NAMESPACE}
                            
                            echo "Checking pod status..."
                            kubectl get pods -n ${K8S_NAMESPACE}
                            
                            echo "Checking service status..."
                            kubectl get svc -n ${K8S_NAMESPACE}
                            
                            echo "Checking ingress status..."
                            kubectl get ingressroute -n ${K8S_NAMESPACE}
                        '''
                    }
                }
            }
        }
    }
    post {
        always {
            script {
                echo "Build completed with status: ${currentBuild.result ?: 'SUCCESS'}"
            }
        }
        success {
            script {
                echo "🎉 Deployment successful!"
                echo "Application URL: https://downlogger.aks.scicomp.ihme.washington.edu"
            }
        }
        failure {
            steps {
                node('docker') {
                    script {
                        echo "❌ Deployment failed!"
                        sh '''
                            # Set up kubeconfig
                            echo "${KUBECONFIG}" > /tmp/kubeconfig
                            export KUBECONFIG=/tmp/kubeconfig
                            
                            echo "Checking pod logs for debugging..."
                            kubectl logs -l app=downlogger -n ${K8S_NAMESPACE} --tail=50 || true
                            
                            echo "Checking pod events..."
                            kubectl get events -n ${K8S_NAMESPACE} --sort-by='.lastTimestamp' --field-selector type!=Normal || true
                        '''
                    }
                }
            }
        }
    }
}
